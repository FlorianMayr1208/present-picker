{% extends "base.html" %}

{% block title %}{{ destination.name }} - Reiseplanung{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="row mb-4">
    <div class="col">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary mb-3">&larr; Zur√ºck zur √úbersicht</a>

        <div class="card shadow">
            {% if destination.image_cover %}
            <img src="{{ url_for('static', filename='images/' + destination.image_cover) }}"
                 class="card-img-top"
                 alt="{{ destination.name }}"
                 style="height: 400px; object-fit: cover;">
            {% endif %}

            <div class="card-body">
                <h1 class="card-title display-4">{{ destination.name }}</h1>
                {% if destination.description_short %}
                <p class="card-text lead">{{ destination.description_short }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Selection Mode: Slider or Checkboxes -->
{% if selection_mode == 'slider' %}
<!-- Slider Section -->
<div class="row mb-4">
    <div class="col">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Detailgrad der Reiseplanung</h5>
                <p class="text-muted mb-3">
                    Bewege den Slider, um mehr Details √ºber die Reise zu erfahren
                </p>

                <div class="mb-3">
                    <label for="detailSlider" class="form-label">
                        Aktueller Level: <strong id="sliderValue">{{ slider_value }}</strong> / {{ slider_max }}
                    </label>
                    <input type="range"
                           class="form-range"
                           id="detailSlider"
                           min="0"
                           max="{{ slider_max }}"
                           value="{{ slider_value }}"
                           step="1">
                </div>

                <div class="d-flex justify-content-between text-muted small">
                    <span>Nur Ziel</span>
                    <span>Voll durchgeplant</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- Checkbox Selection Info with Points Budget -->
<div class="row mb-4">
    <div class="col">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-2">Stelle deine Reise zusammen</h5>
                        <p class="text-muted mb-0">
                            W√§hle die Aktivit√§ten und Erlebnisse aus, die dich interessieren
                        </p>
                    </div>
                    <div class="text-end">
                        <div class="points-display">
                            <span class="points-used" id="pointsUsed">0</span> / <span class="points-total">{{ points_budget }}</span>
                            <div class="small text-muted">Punkte</div>
                        </div>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 8px;">
                    <div class="progress-bar" id="pointsProgressBar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="{{ points_budget }}"></div>
                </div>
                <div class="mt-3 text-end">
                    <button type="button" class="btn btn-primary" id="exportPdfBtn">
                        <i class="bi bi-file-earmark-pdf"></i> Als PDF exportieren
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Parents' Gift Section -->
{% if parents_activities and parents_activities|length > 0 and selection_mode == 'checkboxes' %}
<div class="row mb-5">
    <div class="col">
        <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body text-white text-center">
                <h4 class="mb-2" style="font-size: 2.5rem;">üéÅ üë¥üëµ</h4>
                <p class="mb-0 small">W√§hle 1 von {{ parents_activities|length }} Aktivit√§ten</p>
            </div>
        </div>

        <div class="mt-3">
            {% for item in parents_activities %}
            <div class="card mb-3 shadow-sm parents-gift-card">
                <div class="row g-0">
                    {% if item.sub_item.image_filename %}
                    <div class="col-md-3">
                        <img src="{% if item.sub_item.image_filename.startswith('http') %}{{ item.sub_item.image_filename }}{% else %}{{ url_for('static', filename='images/' + item.sub_item.image_filename) }}{% endif %}"
                             class="img-fluid rounded-start h-100"
                             alt="{{ item.sub_item.title }}"
                             style="object-fit: cover; min-height: 180px;">
                    </div>
                    {% endif %}
                    <div class="{% if item.sub_item.image_filename %}col-md-9{% else %}col-md-12{% endif %}">
                        <div class="card-body py-3 px-4">
                            <div class="form-check d-flex align-items-start gap-3">
                                <input class="form-check-input parents-gift-radio flex-shrink-0 mt-1"
                                       type="radio"
                                       name="parents_gift"
                                       id="parents-{{ item.sub_item.id }}"
                                       data-parent-id="{{ item.activity_id }}"
                                       data-sub-id="{{ item.sub_item.id }}"
                                       data-points="{{ item.sub_item.points|default(0) }}">
                                <label class="form-check-label flex-grow-1" for="parents-{{ item.sub_item.id }}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>{{ item.sub_item.title }}</strong>
                                            {% if item.sub_item.description %}
                                            <br><small class="text-muted" style="line-height: 1.6;">{{ item.sub_item.description }}</small>
                                            {% endif %}
                                        </div>
                                        <span class="badge bg-gradient flex-shrink-0 ms-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 1.2rem;">
                                            üéÅüë¥üëµ
                                        </span>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Friends' Gift Section -->
{% if friends_activities and friends_activities|length > 0 and selection_mode == 'checkboxes' %}
<div class="row mb-5">
    <div class="col">
        <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="card-body text-white text-center">
                <h4 class="mb-2" style="font-size: 2.5rem;">
                    <img src="{{ url_for('static', filename='assets/lolo.png') }}" alt="Geschenk von Freunden" style="width: 60px; height: 60px; object-fit: contain; vertical-align: middle;">
                </h4>
                <p class="mb-0 small">W√§hle 1 von {{ friends_activities|length }} Aktivit√§ten</p>
            </div>
        </div>

        <div class="mt-3">
            {% for item in friends_activities %}
            <div class="card mb-3 shadow-sm friends-gift-card">
                <div class="row g-0">
                    {% if item.sub_item.image_filename %}
                    <div class="col-md-3">
                        <img src="{% if item.sub_item.image_filename.startswith('http') %}{{ item.sub_item.image_filename }}{% else %}{{ url_for('static', filename='images/' + item.sub_item.image_filename) }}{% endif %}"
                             class="img-fluid rounded-start h-100"
                             alt="{{ item.sub_item.title }}"
                             style="object-fit: cover; min-height: 180px;">
                    </div>
                    {% endif %}
                    <div class="{% if item.sub_item.image_filename %}col-md-9{% else %}col-md-12{% endif %}">
                        <div class="card-body py-3 px-4">
                            <div class="form-check d-flex align-items-start gap-3">
                                <input class="form-check-input friends-gift-radio flex-shrink-0 mt-1"
                                       type="radio"
                                       name="friends_gift"
                                       id="friends-{{ item.sub_item.id }}"
                                       data-friend-id="{{ item.activity_id }}"
                                       data-sub-id="{{ item.sub_item.id }}"
                                       data-points="{{ item.sub_item.points|default(0) }}">
                                <label class="form-check-label flex-grow-1" for="friends-{{ item.sub_item.id }}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>{{ item.sub_item.title }}</strong>
                                            {% if item.sub_item.description %}
                                            <br><small class="text-muted" style="line-height: 1.6;">{{ item.sub_item.description }}</small>
                                            {% endif %}
                                        </div>
                                        <img src="{{ url_for('static', filename='assets/lolo.png') }}" alt="Geschenk von Freunden" class="flex-shrink-0 ms-2" style="width: 50px; height: 50px; object-fit: contain;">
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Activities Section -->
<div class="row">
    <div class="col">
        <h3 class="mb-3">Aktivit√§ten & Details</h3>

        <div id="activitiesContainer">
            {% if activities %}
                {% if selection_mode == 'checkboxes' %}
                    <!-- Checkbox Mode: Show activities with checkboxes -->
                    {% for activity in activities %}
                    <div class="mb-4 activity-category">
                        <!-- Category Header with Image -->
                        {% if activity.image_filename %}
                        <div class="card mb-3 shadow-sm category-header-card">
                            <div class="position-relative" style="height: 300px; overflow: hidden;">
                                <img src="{% if activity.image_filename.startswith('http') %}{{ activity.image_filename }}{% else %}{{ url_for('static', filename='images/' + activity.image_filename) }}{% endif %}"
                                     class="w-100 h-100"
                                     alt="{{ activity.title }}"
                                     style="object-fit: cover; object-position: center;">
                                <div class="position-absolute bottom-0 start-0 w-100 p-4" style="background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);">
                                    <h4 class="text-white mb-2">{{ activity.title }}</h4>
                                    {% if activity.description %}
                                    <p class="text-white mb-0 small">{{ activity.description }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- Category Header without Image -->
                        <div class="card mb-3 shadow-sm">
                            <div class="card-body p-4">
                                <h5 class="mb-2">{{ activity.title }}</h5>
                                {% if activity.description %}
                                <p class="card-text text-muted mb-0" style="line-height: 1.6;">{{ activity.description }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Sub-items Container -->
                        {% if activity.sub_items %}
                        <div class="sub-items-container">
                            {% for sub_item in activity.sub_items %}
                            <div class="card mb-3 sub-item-card shadow-sm">
                                <div class="row g-0">
                                    {% if sub_item.image_filename %}
                                    <div class="col-md-3">
                                        <img src="{% if sub_item.image_filename.startswith('http') %}{{ sub_item.image_filename }}{% else %}{{ url_for('static', filename='images/' + sub_item.image_filename) }}{% endif %}"
                                             class="img-fluid rounded-start h-100"
                                             alt="{{ sub_item.title }}"
                                             style="object-fit: cover; min-height: 120px;">
                                    </div>
                                    {% endif %}
                                    <div class="{% if sub_item.image_filename %}col-md-9{% else %}col-md-12{% endif %}">
                                        <div class="card-body py-3 px-4">
                                            <div class="form-check">
                                                <input class="form-check-input sub-item-checkbox"
                                                       type="checkbox"
                                                       id="sub-{{ sub_item.id }}"
                                                       data-parent-id="{{ activity.id }}"
                                                       data-sub-id="{{ sub_item.id }}"
                                                       data-points="{{ sub_item.points|default(0) }}"
                                                       {% if sub_item.is_spontaneous %}data-spontaneous="true"{% endif %}
                                                       {% if sub_item.default_selected %}checked{% endif %}
                                                       {% if sub_item.mandatory %}disabled{% endif %}>
                                                <label class="form-check-label w-100" for="sub-{{ sub_item.id }}">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div>
                                                            <strong>{{ sub_item.title }}</strong>
                                                            {% if sub_item.description %}
                                                            <br><small class="text-muted" style="line-height: 1.6;">{{ sub_item.description }}</small>
                                                            {% endif %}
                                                        </div>
                                                        <span class="badge {% if sub_item.is_spontaneous %}bg-info{% else %}bg-secondary{% endif %} ms-2 points-badge" id="badge-sub-{{ sub_item.id }}">
                                                            {{ sub_item.points|default(0) }} Pkt
                                                        </span>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <!-- Slider Mode: Show activities as card grid -->
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                    {% for activity in activities %}
                        <div class="col activity-card" data-level-min="{{ activity.slider_level_min }}" data-level-max="{{ activity.slider_level_max }}">
                            <div class="card h-100 shadow-sm activity-grid-card">
                                {% if activity.image_filename %}
                                <div class="slider-image-container">
                                    <img src="{% if activity.image_filename.startswith('http') %}{{ activity.image_filename }}{% else %}{{ url_for('static', filename='images/' + activity.image_filename) }}{% endif %}"
                                         class="card-img-top"
                                         alt="{{ activity.title }}"
                                         style="height: 180px; object-fit: cover;">
                                    <span class="badge bg-primary position-absolute top-0 end-0 m-2" style="font-size: 0.7rem; z-index: 10;">Level {{ activity.slider_level_min }}-{{ activity.slider_level_max }}</span>
                                </div>
                                {% endif %}
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h6 class="card-title mb-2">{{ activity.title }}</h6>
                                    </div>

                                    {% if activity.description %}
                                    <p class="card-text small text-muted mb-3" style="font-size: 0.8rem; line-height: 1.6;">{{ activity.description }}</p>
                                    {% endif %}

                                    {% if activity.sub_items %}
                                    <div class="sub-items-list">
                                        {% for sub_item in activity.sub_items %}
                                        <div class="sub-item-row mb-2" onclick="toggleSubItemDescription(this)" style="cursor: pointer;">
                                            <div class="sub-item-wrapper">
                                                {% if sub_item.image_filename %}
                                                <div class="sub-item-image-container">
                                                    <img src="{% if sub_item.image_filename.startswith('http') %}{{ sub_item.image_filename }}{% else %}{{ url_for('static', filename='images/' + sub_item.image_filename) }}{% endif %}"
                                                         alt="{{ sub_item.title }}"
                                                         class="sub-item-image-zoom"
                                                         onclick="openImageModal('{% if sub_item.image_filename.startswith('http') %}{{ sub_item.image_filename }}{% else %}{{ url_for('static', filename='images/' + sub_item.image_filename) }}{% endif %}', event)"
                                                         style="width: 40px; height: 40px; object-fit: cover;">
                                                </div>
                                                {% endif %}
                                                <div class="sub-item-content">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <small class="fw-bold" style="font-size: 0.85rem;">{{ sub_item.title }}</small>
                                                        {% if sub_item.from_parents %}
                                                        <span style="font-size: 0.9rem;">üéÅüë¥üëµ</span>
                                                        {% endif %}
                                                        {% if sub_item.from_friends %}
                                                        <img src="{{ url_for('static', filename='assets/lolo.png') }}" alt="Geschenk von Freunden" style="width: 30px; height: 30px; object-fit: contain;">
                                                        {% endif %}
                                                        <i class="bi bi-chevron-down sub-item-icon" style="font-size: 0.75rem; transition: transform 0.3s; margin-left: auto;"></i>
                                                    </div>
                                                    <div class="sub-item-description" style="display: none; margin-top: 0.5rem; padding: 0.5rem;">
                                                        {% if sub_item.description %}
                                                        <small class="text-muted" style="font-size: 0.75rem; line-height: 1.6;">{{ sub_item.description }}</small>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    </div>
                {% endif %}
            {% else %}
                <div class="alert alert-info" role="alert" id="noActivitiesMessage">
                    Bewege den Slider nach rechts, um Details √ºber diese Reise zu sehen.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Image Modal for Slider Mode -->
<div id="imageModal" class="image-modal" onclick="closeImageModal()">
    <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
    <img id="modalImage" src="" alt="Vergr√∂√üerte Ansicht">
</div>
{% endblock %}

{% block extra_js %}
<script>
    const selectionMode = '{{ selection_mode }}';
    const destinationId = {{ destination.id }};

    {% if selection_mode == 'slider' %}
    // ========== SLIDER MODE ==========
    const slider = document.getElementById('detailSlider');
    const sliderValue = document.getElementById('sliderValue');
    const activitiesContainer = document.getElementById('activitiesContainer');
    let isLoading = false;

    // Update slider value display
    slider.addEventListener('input', function() {
        sliderValue.textContent = this.value;
    });

    // Update activities when slider changes (AJAX)
    slider.addEventListener('input', debounce(function() {
        const newValue = this.value;
        loadActivities(newValue);
    }, 300)); // 300ms debounce

    function loadActivities(sliderLevel) {
        if (isLoading) return;
        isLoading = true;

        // Zeige Loading-Zustand
        activitiesContainer.style.opacity = '0.5';

        // Hole Aktivit√§ten via AJAX
        fetch(`/api/destination/${destinationId}/activities?slider=${sliderLevel}`)
            .then(response => response.json())
            .then(data => {
                renderActivities(data.activities);
                isLoading = false;
                activitiesContainer.style.opacity = '1';
            })
            .catch(error => {
                console.error('Fehler beim Laden der Aktivit√§ten:', error);
                isLoading = false;
                activitiesContainer.style.opacity = '1';
            });
    }

    function renderActivities(activities) {
        if (activities.length === 0) {
            activitiesContainer.innerHTML = `
                <div class="alert alert-info" role="alert">
                    Bewege den Slider nach rechts, um Details √ºber diese Reise zu sehen.
                </div>
            `;
            return;
        }

        let html = '<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">';

        activities.forEach(activity => {
            const hasImage = activity.image_filename ? true : false;

            html += `
                <div class="col activity-card" data-level-min="${activity.slider_level_min}" data-level-max="${activity.slider_level_max}" style="animation: fadeIn 0.5s ease-in;">
                    <div class="card h-100 shadow-sm activity-grid-card">
                        ${hasImage ? `
                        <div class="slider-image-container">
                            <img src="${activity.image_filename.startsWith('http') ? activity.image_filename : '/static/images/' + activity.image_filename}"
                                 class="card-img-top"
                                 alt="${escapeHtml(activity.title)}"
                                 style="height: 180px; object-fit: cover;">
                            <span class="badge bg-primary position-absolute top-0 end-0 m-2" style="font-size: 0.7rem; z-index: 10;">Level ${activity.slider_level_min}-${activity.slider_level_max}</span>
                        </div>
                        ` : ''}
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="card-title mb-2">${escapeHtml(activity.title)}</h6>
                            </div>

                            ${activity.description ? `<p class="card-text small text-muted mb-3" style="font-size: 0.8rem; line-height: 1.6;">${escapeHtml(activity.description)}</p>` : ''}

                            ${activity.sub_items && activity.sub_items.length > 0 ? `
                            <div class="sub-items-list">
                                ${activity.sub_items.map(subItem => {
                                    return `
                                    <div class="sub-item-row mb-2" onclick="toggleSubItemDescription(this)" style="cursor: pointer;">
                                        <div class="sub-item-wrapper">
                                            ${subItem.image_filename ? `
                                            <div class="sub-item-image-container">
                                                <img src="${subItem.image_filename.startsWith('http') ? subItem.image_filename : '/static/images/' + subItem.image_filename}"
                                                     alt="${escapeHtml(subItem.title)}"
                                                     class="sub-item-image-zoom"
                                                     onclick="openImageModal('${subItem.image_filename.startsWith('http') ? subItem.image_filename : '/static/images/' + subItem.image_filename}', event)"
                                                     style="width: 40px; height: 40px; object-fit: cover;">
                                            </div>
                                            ` : ''}
                                            <div class="sub-item-content">
                                                <div class="d-flex align-items-center gap-2">
                                                    <small class="fw-bold" style="font-size: 0.85rem;">${escapeHtml(subItem.title)}</small>
                                                    ${subItem.from_parents ? `<span style="font-size: 0.9rem;">üéÅüë¥üëµ</span>` : ''}
                                                    ${subItem.from_friends ? `<img src="/static/assets/lolo.png" alt="Geschenk von Freunden" style="width: 30px; height: 30px; object-fit: contain;">` : ''}
                                                    <i class="bi bi-chevron-down sub-item-icon" style="font-size: 0.75rem; transition: transform 0.3s; margin-left: auto;"></i>
                                                </div>
                                                <div class="sub-item-description" style="display: none; margin-top: 0.5rem; padding: 0.5rem;">
                                                    ${subItem.description ? `<small class="text-muted" style="font-size: 0.75rem; line-height: 1.6;">${escapeHtml(subItem.description)}</small>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        activitiesContainer.innerHTML = html;
    }

    // URL aktualisieren ohne Reload (f√ºr Browser-History)
    slider.addEventListener('change', function() {
        const newValue = this.value;
        const newUrl = `{{ url_for('show_destination', id=destination.id) }}?slider=${newValue}`;
        window.history.pushState({slider: newValue}, '', newUrl);
    });

    {% else %}
    // ========== CHECKBOX MODE ==========
    const pointsBudget = {{ points_budget }};
    const pointsUsedElement = document.getElementById('pointsUsed');
    const pointsProgressBar = document.getElementById('pointsProgressBar');

    const subCheckboxes = document.querySelectorAll('.sub-item-checkbox');

    // Track selections
    let selectedActivities = {};

    // Find spontaneous checkbox
    const spontaneousCheckbox = document.querySelector('.sub-item-checkbox[data-spontaneous="true"]');

    // Calculate current points (excluding spontaneous option and gift items)
    function calculatePoints() {
        let totalPoints = 0;
        subCheckboxes.forEach(checkbox => {
            if (checkbox.checked && !checkbox.dataset.spontaneous) {
                const points = parseInt(checkbox.dataset.points) || 0;
                totalPoints += points;
            }
        });

        // Note: Parents' and friends' gift items do NOT count towards the points budget
        // They are separate selections that don't cost points

        return totalPoints;
    }

    // Calculate remaining points
    function calculateRemainingPoints() {
        const usedPoints = calculatePoints();
        return Math.max(0, pointsBudget - usedPoints);
    }

    // Update spontaneous option
    function updateSpontaneousOption() {
        if (!spontaneousCheckbox) return;

        const remainingPoints = calculateRemainingPoints();
        const badge = document.getElementById('badge-' + spontaneousCheckbox.id);

        // Update badge text
        if (badge) {
            badge.textContent = remainingPoints + ' Pkt';
        }

        // Update data-points attribute for calculation
        spontaneousCheckbox.dataset.points = remainingPoints;

        // Disable if no points remaining
        if (remainingPoints === 0 && !spontaneousCheckbox.checked) {
            spontaneousCheckbox.disabled = true;
        } else if (remainingPoints > 0) {
            spontaneousCheckbox.disabled = false;
        }
    }

    // Update points display and progress bar
    function updatePointsDisplay() {
        // Update spontaneous option first
        updateSpontaneousOption();

        // Calculate total including spontaneous if checked
        let currentPoints = calculatePoints();
        if (spontaneousCheckbox && spontaneousCheckbox.checked) {
            currentPoints += parseInt(spontaneousCheckbox.dataset.points) || 0;
        }

        pointsUsedElement.textContent = currentPoints;

        // Update progress bar
        const percentage = (currentPoints / pointsBudget) * 100;
        pointsProgressBar.style.width = percentage + '%';
        pointsProgressBar.setAttribute('aria-valuenow', currentPoints);

        // Color coding
        pointsProgressBar.classList.remove('bg-success', 'bg-warning', 'bg-danger');
        pointsUsedElement.classList.remove('over-budget');

        if (currentPoints > pointsBudget) {
            pointsProgressBar.classList.add('bg-danger');
            pointsUsedElement.classList.add('over-budget');
        } else if (percentage >= 80) {
            pointsProgressBar.classList.add('bg-warning');
        } else {
            pointsProgressBar.classList.add('bg-success');
        }

        // Disable/enable checkboxes based on budget
        updateCheckboxStates();
    }

    // Update checkbox enabled/disabled states
    function updateCheckboxStates() {
        const currentPoints = calculatePoints();

        subCheckboxes.forEach(checkbox => {
            // Skip spontaneous checkbox - it has its own logic
            if (checkbox.dataset.spontaneous) {
                return;
            }

            // Don't disable mandatory items or already checked items
            if (checkbox.hasAttribute('disabled') && !checkbox.dataset.points) {
                return; // Skip mandatory items
            }

            if (!checkbox.checked) {
                const points = parseInt(checkbox.dataset.points) || 0;

                // If spontaneous is checked, budget is considered full - disable all other options
                if (spontaneousCheckbox && spontaneousCheckbox.checked) {
                    checkbox.disabled = true;
                } else {
                    // Normal budget check
                    const wouldExceedBudget = (currentPoints + points) > pointsBudget;
                    checkbox.disabled = wouldExceedBudget;
                }
            }
        });
    }

    // Sub-item checkbox change handler
    subCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const activityId = this.dataset.parentId;
            const subId = this.dataset.subId;

            // Initialize activity if needed
            if (!selectedActivities[activityId]) {
                selectedActivities[activityId] = { subItems: {} };
            }

            selectedActivities[activityId].subItems[subId] = this.checked;

            updatePointsDisplay();
            logSelection();
        });
    });

    // Log current selection (for debugging / future API call)
    function logSelection() {
        const regularPoints = calculatePoints();
        const spontaneousPoints = (spontaneousCheckbox && spontaneousCheckbox.checked) ? parseInt(spontaneousCheckbox.dataset.points) : 0;
        const totalPoints = regularPoints + spontaneousPoints;

        console.log('Current selection:', selectedActivities);
        console.log('Regular points:', regularPoints);
        console.log('Spontaneous points:', spontaneousPoints);
        console.log('Total points:', totalPoints, '/', pointsBudget);
        console.log('Remaining:', pointsBudget - totalPoints);
        // TODO: Save to session/cookie or API
    }

    // Gift radio button change handlers
    document.querySelectorAll('.parents-gift-radio, .friends-gift-radio').forEach(radio => {
        radio.addEventListener('change', function() {
            updatePointsDisplay();
        });
    });

    // Initialize points display on page load
    updatePointsDisplay();

    // PDF Export handler
    document.getElementById('exportPdfBtn').addEventListener('click', function() {
        // Collect selected activities
        const selectedItems = [];

        subCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const activityId = checkbox.dataset.parentId;
                const subId = checkbox.dataset.subId;
                const points = parseInt(checkbox.dataset.points) || 0;

                selectedItems.push({
                    activity_id: activityId,
                    sub_id: subId,
                    points: points
                });
            }
        });

        // Add parents' gift selection if any
        const parentsGiftRadio = document.querySelector('.parents-gift-radio:checked');
        if (parentsGiftRadio) {
            selectedItems.push({
                activity_id: parentsGiftRadio.dataset.parentId,
                sub_id: parentsGiftRadio.dataset.subId,
                points: parseInt(parentsGiftRadio.dataset.points) || 0,
                from_parents: true
            });
        }

        // Add friends' gift selection if any
        const friendsGiftRadio = document.querySelector('.friends-gift-radio:checked');
        if (friendsGiftRadio) {
            selectedItems.push({
                activity_id: friendsGiftRadio.dataset.friendId,
                sub_id: friendsGiftRadio.dataset.subId,
                points: parseInt(friendsGiftRadio.dataset.points) || 0,
                from_friends: true
            });
        }

        if (selectedItems.length === 0) {
            alert('Bitte w√§hle zuerst einige Aktivit√§ten aus!');
            return;
        }

        // Send to backend
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/destination/{{ destination.id }}/export-pdf';
        form.target = '_blank';

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'selected_items';
        input.value = JSON.stringify(selectedItems);

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    });
    {% endif %}

    // ========== SHARED HELPER FUNCTIONS ==========
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func.apply(this, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    // Toggle individual sub-item description expansion/collapse
    function toggleSubItemDescription(subItemRow) {
        const description = subItemRow.querySelector('.sub-item-description');
        const icon = subItemRow.querySelector('.sub-item-icon');

        if (!description) return;

        // Check if currently expanded
        const isExpanded = description.style.display === 'block';

        if (isExpanded) {
            // Collapse
            description.style.display = 'none';
            if (icon) icon.style.transform = 'rotate(0deg)';
            subItemRow.classList.remove('expanded');
        } else {
            // Expand
            description.style.display = 'block';
            if (icon) icon.style.transform = 'rotate(180deg)';
            subItemRow.classList.add('expanded');

            // Scroll to the item smoothly
            setTimeout(() => {
                subItemRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }
    }

    // Image modal functions
    function openImageModal(imageSrc, event) {
        event.stopPropagation(); // Prevent card expansion when clicking image
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');

        modalImg.src = imageSrc;
        modal.classList.add('active');

        // Prevent body scroll when modal is open
        document.body.style.overflow = 'hidden';
    }

    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.remove('active');

        // Re-enable body scroll
        document.body.style.overflow = 'auto';
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeImageModal();
        }
    });
</script>
{% endblock %}
