{% extends "base.html" %}

{% block title %}{{ destination.name }} - Reiseplanung{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="row mb-4">
    <div class="col">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary mb-3">&larr; Zurück zur Übersicht</a>

        <div class="card shadow">
            {% if destination.image_cover %}
            <img src="{{ url_for('static', filename='images/' + destination.image_cover) }}"
                 class="card-img-top"
                 alt="{{ destination.name }}"
                 style="height: 400px; object-fit: cover;">
            {% endif %}

            <div class="card-body">
                <h1 class="card-title display-4">{{ destination.name }}</h1>
                {% if destination.description_short %}
                <p class="card-text lead">{{ destination.description_short }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Slider Section -->
<div class="row mb-4">
    <div class="col">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Detailgrad der Reiseplanung</h5>
                <p class="text-muted mb-3">
                    Bewege den Slider, um mehr Details über die Reise zu erfahren
                </p>

                <div class="mb-3">
                    <label for="detailSlider" class="form-label">
                        Aktueller Level: <strong id="sliderValue">{{ slider_value }}</strong> / {{ slider_max }}
                    </label>
                    <input type="range"
                           class="form-range"
                           id="detailSlider"
                           min="0"
                           max="{{ slider_max }}"
                           value="{{ slider_value }}"
                           step="1">
                </div>

                <div class="d-flex justify-content-between text-muted small">
                    <span>Nur Ziel</span>
                    <span>Voll durchgeplant</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Activities Section -->
<div class="row">
    <div class="col">
        <h3 class="mb-3">Aktivitäten & Details</h3>

        <div id="activitiesContainer">
            {% if activities %}
                {% for activity in activities %}
                <div class="card mb-3 shadow-sm activity-card" data-level-min="{{ activity.slider_level_min }}" data-level-max="{{ activity.slider_level_max }}">
                    <div class="row g-0">
                        {% if activity.image_filename %}
                        <div class="col-md-4">
                            <img src="{% if activity.image_filename.startswith('http') %}{{ activity.image_filename }}{% else %}{{ url_for('static', filename='images/' + activity.image_filename) }}{% endif %}"
                                 class="img-fluid rounded-start h-100"
                                 alt="{{ activity.title }}"
                                 style="object-fit: cover;">
                        </div>
                        {% endif %}

                        <div class="{% if activity.image_filename %}col-md-8{% else %}col-md-12{% endif %}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="card-title mb-0">{{ activity.title }}</h5>
                                    <span class="badge bg-primary">Level {{ activity.slider_level_min }}-{{ activity.slider_level_max }}</span>
                                </div>
                                {% if activity.description %}
                                <p class="card-text">{{ activity.description }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info" role="alert" id="noActivitiesMessage">
                    Bewege den Slider nach rechts, um Details über diese Reise zu sehen.
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .activity-card {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .form-range::-webkit-slider-thumb {
        background: #0d6efd;
    }

    .form-range::-moz-range-thumb {
        background: #0d6efd;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    const slider = document.getElementById('detailSlider');
    const sliderValue = document.getElementById('sliderValue');
    const activitiesContainer = document.getElementById('activitiesContainer');
    const destinationId = {{ destination.id }};
    let isLoading = false;

    // Update slider value display
    slider.addEventListener('input', function() {
        sliderValue.textContent = this.value;
    });

    // Update activities when slider changes (AJAX)
    slider.addEventListener('input', debounce(function() {
        const newValue = this.value;
        loadActivities(newValue);
    }, 300)); // 300ms debounce

    function loadActivities(sliderLevel) {
        if (isLoading) return;
        isLoading = true;

        // Zeige Loading-Zustand
        activitiesContainer.style.opacity = '0.5';

        // Hole Aktivitäten via AJAX
        fetch(`/api/destination/${destinationId}/activities?slider=${sliderLevel}`)
            .then(response => response.json())
            .then(data => {
                renderActivities(data.activities);
                isLoading = false;
                activitiesContainer.style.opacity = '1';
            })
            .catch(error => {
                console.error('Fehler beim Laden der Aktivitäten:', error);
                isLoading = false;
                activitiesContainer.style.opacity = '1';
            });
    }

    function renderActivities(activities) {
        if (activities.length === 0) {
            activitiesContainer.innerHTML = `
                <div class="alert alert-info" role="alert">
                    Bewege den Slider nach rechts, um Details über diese Reise zu sehen.
                </div>
            `;
            return;
        }

        let html = '';
        activities.forEach(activity => {
            const hasImage = activity.image_filename ? true : false;
            const imageCol = hasImage ? 'col-md-4' : '';
            const contentCol = hasImage ? 'col-md-8' : 'col-md-12';

            html += `
                <div class="card mb-3 shadow-sm activity-card" data-level-min="${activity.slider_level_min}" data-level-max="${activity.slider_level_max}" style="animation: fadeIn 0.5s ease-in;">
                    <div class="row g-0">
                        ${hasImage ? `
                        <div class="${imageCol}">
                            <img src="${activity.image_filename.startsWith('http') ? activity.image_filename : '/static/images/' + activity.image_filename}"
                                 class="img-fluid rounded-start h-100"
                                 alt="${escapeHtml(activity.title)}"
                                 style="object-fit: cover;">
                        </div>
                        ` : ''}
                        <div class="${contentCol}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="card-title mb-0">${escapeHtml(activity.title)}</h5>
                                    <span class="badge bg-primary">Level ${activity.slider_level_min}-${activity.slider_level_max}</span>
                                </div>
                                ${activity.description ? `<p class="card-text">${escapeHtml(activity.description)}</p>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        activitiesContainer.innerHTML = html;
    }

    // Hilfsfunktion: Debounce
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func.apply(this, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Hilfsfunktion: HTML escapen
    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    // URL aktualisieren ohne Reload (für Browser-History)
    slider.addEventListener('change', function() {
        const newValue = this.value;
        const newUrl = `{{ url_for('show_destination', id=destination.id) }}?slider=${newValue}`;
        window.history.pushState({slider: newValue}, '', newUrl);
    });
</script>
{% endblock %}
